(function(E,I,r,d,T,te,h,C){"use strict";const n={DEFAULT_APP_NAME:"Music",DEFAULT_TIME_INTERVAL:5,APPLICATION_ID:"1054951789318909972",MIN_UPDATE_INTERVAL:3,MAX_RETRY_ATTEMPTS:3,RETRY_DELAY:5e3,LFM_API_BASE_URL:"http://ws.audioscrobbler.com/2.0",LFM_DEFAULT_COVER_HASHES:["2a96cbd8b46e442fc41c2b86b821562f","c6f59c1e5e7240a4c0d427abd71f3dbb"],DEFAULT_SETTINGS:{username:"",apiKey:"",appName:"Music",timeInterval:5,showTimestamp:!0,listeningTo:!0,ignoreSpotify:!0,verboseLogging:!1,idleDisplayMode:"lastPlayed"},IDLE_DISPLAY_OPTIONS:[{label:"Last Played Song",value:"lastPlayed"},{label:"Top Artist",value:"topArtist"},{label:"Top Song",value:"topSong"},{label:"Top Album",value:"topAlbum"}],GITHUB_URL:"https://github.com/kmmiio99o/letup",GITHUB_COMMITS_URL:"https://github.com/kmmiio99o/letup/commits/main/"};function F(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function O(t,e){for(var a=0;a<e.length;a++){var s=e[a];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function $(t,e,a){return e&&O(t.prototype,e),a&&O(t,a),t}h.findByProps("SET_ACTIVITY");const K=h.findByProps("getAssetIds"),z=h.findByStoreName("SelfPresenceStore"),G=h.findByStoreName("UserStore");function N(){return D(null)}function D(t){p.pluginStopped&&(B(),t=null),p.lastActivity=t,r.FluxDispatcher.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:t,pid:2312,socketId:"Last.fm@Vendetta"})}async function S(t,e=n.APPLICATION_ID){if(!t?.length)return[];try{return await K.fetchAssetIds(e,t)}catch(a){return console.error("[Last.fm] Failed to fetch assets:",a),[]}}const w={};w.componentMountErrors=[],w.componentMountCount=0,w.settingsLoadAttempts=0;function b(t,e){w[t]=e}const v=function(){function t(){F(this,t)}return $(t,[{key:"fetchTopArtist",value:async function(){this.validateSettings();const e=(await this.makeRequest({method:"user.gettopartists",user:l.username,limit:"1"}))?.topartists?.artist?.[0];if(!e)throw new Error("No top artist found");return{name:e.name,url:e.url,image:e.image?.find(function(a){return a.size==="large"})?.["#text"]}}},{key:"fetchTopTrack",value:async function(){this.validateSettings();const e=(await this.makeRequest({method:"user.gettoptracks",user:l.username,limit:"1"}))?.toptracks?.track?.[0];if(!e)throw new Error("No top track found");return{name:e.name,artist:e.artist?.name,url:e.url,image:e.image?.find(function(a){return a.size==="large"})?.["#text"]}}},{key:"fetchTopAlbum",value:async function(){this.validateSettings();const e=(await this.makeRequest({method:"user.gettopalbums",user:l.username,limit:"1"}))?.topalbums?.album?.[0];if(!e)throw new Error("No top album found");return{name:e.name,artist:e.artist?.name,url:e.url,image:e.image?.find(function(a){return a.size==="large"})?.["#text"]}}},{key:"validateSettings",value:function(){if(!l.username)throw new Error("Last.fm username is not set");if(!l.apiKey)throw new Error("Last.fm API key is not set")}},{key:"handleError",value:async function(e){this.lastError=e.error;const a={2:"Invalid API key",11:"Service temporarily unavailable",16:"Service temporarily unavailable",29:"Rate limit exceeded"}[e.error]||e.message||"Unknown error";throw T.showToast(`Last.fm Error: ${a}`,d.getAssetIDByName("Small")),new Error(`Last.fm API Error ${e.error}: ${a}`)}},{key:"makeRequest",value:async function(e){const a=new URLSearchParams({...e,api_key:l.apiKey,format:"json"}).toString(),s=await fetch(`${n.LFM_API_BASE_URL}?${a}`),c=await s.json();return(!s.ok||c.error)&&await this.handleError(c),c}},{key:"fetchLatestScrobble",value:async function(){try{this.validateSettings();const e=(await this.makeRequest({method:"user.getrecenttracks",user:l.username,limit:"1",extended:"1"}))?.recenttracks?.track?.[0];if(b("lastAPIResponse",e),!e)throw new Error("No tracks found");this.retryCount=0;const a=!!e["@attr"]?.nowplaying;let s;a?s=Math.floor(Date.now()/1e3):e?.date&&typeof e.date=="object"&&"uts"in e.date?s=parseInt(e.date.uts):s=Math.floor(Date.now()/1e3);let c=null;try{const o=await this.makeRequest({method:"track.getInfo",track:e.name,artist:e.artist.name,username:l.username}),i=parseInt(o?.track?.duration);i>0&&(c=s+Math.floor(i/1e3))}catch(o){console.warn("Failed to fetch track duration",o)}return{name:e.name,artist:e.artist.name,album:e.album["#text"],albumArt:await this.handleAlbumCover(e.image?.find(function(o){return o.size==="large"})?.["#text"]),url:e.url,date:e.date?.["#text"]??"now",nowPlaying:a,loved:e.loved==="1",from:s,to:c}}catch(e){if(this.retryCount++,this.retryCount>n.MAX_RETRY_ATTEMPTS)throw this.retryCount=0,e;return await new Promise(function(a){return setTimeout(a,n.RETRY_DELAY)}),this.fetchLatestScrobble()}}},{key:"handleAlbumCover",value:async function(e){return!e||n.LFM_DEFAULT_COVER_HASHES.some(function(a){return e.includes(a)})?null:e}},{key:"getLastError",value:function(){return this.lastError}},{key:"resetRetryCount",value:function(){this.retryCount=0}}],[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}]),t}().getInstance();function j(t){const e=Math.floor(t/60),a=Math.floor(t%60);return`${e}:${a.toString().padStart(2,"0")}`}var H=function(t){return t[t.PLAYING=0]="PLAYING",t[t.STREAMING=1]="STREAMING",t[t.LISTENING=2]="LISTENING",t[t.COMPETING=5]="COMPETING",t}(H||{});const u=function(...t){return l.verboseLogging&&console.log("[Last.fm]",...t)},V=function(){function t(){F(this,t)}return $(t,[{key:"updateActivity",value:async function(){if(p.pluginStopped){u("Plugin is stopped, skipping update"),this.stopUpdates();return}u("Fetching last track...");try{if(!l.username||!l.apiKey)throw new Error("Username or API key not set");if(l.ignoreSpotify){if(z.findActivity(function(s){return s.sync_id})){u("Spotify is currently playing, clearing activity"),b("isSpotifyIgnored",!0),N();return}b("isSpotifyIgnored",!1)}const e=await v.fetchLatestScrobble();if(b("lastTrack",e),!e.nowPlaying){u("Last track is not currently playing");let s=l.idleDisplayMode||n.DEFAULT_SETTINGS.idleDisplayMode,c=null;try{if(s==="lastPlayed"){if(c={name:l.appName||n.DEFAULT_APP_NAME,flags:0,type:l.listeningTo?2:0,details:e.name,state:`by ${e.artist}`,application_id:n.APPLICATION_ID},e.album){const o=await S([e.albumArt]);o[0]&&(c.assets={large_image:o[0],large_text:`on ${e.album}`})}}else if(s==="topArtist"){const o=await v.fetchTopArtist();if(c={name:l.appName||n.DEFAULT_APP_NAME,flags:0,type:2,details:`Top Artist: ${o.name}`,state:"",application_id:n.APPLICATION_ID},o.image){const i=await S([o.image]);i[0]&&(c.assets={large_image:i[0],large_text:o.name})}}else if(s==="topSong"){const o=await v.fetchTopTrack();if(c={name:l.appName||n.DEFAULT_APP_NAME,flags:0,type:2,details:`Top Song: ${o.name}`,state:`by ${o.artist}`,application_id:n.APPLICATION_ID},o.image){const i=await S([o.image]);i[0]&&(c.assets={large_image:i[0],large_text:o.name})}}else if(s==="topAlbum"){const o=await v.fetchTopAlbum();if(c={name:l.appName||n.DEFAULT_APP_NAME,flags:0,type:2,details:`Top Album: ${o.name}`,state:`by ${o.artist}`,application_id:n.APPLICATION_ID},o.image){const i=await S([o.image]);i[0]&&(c.assets={large_image:i[0],large_text:o.name})}}}catch(o){u("Idle status fetch failed",o)}c?(u("Setting idle activity:",c),await D(c),p.lastActivity=c):N();return}if(p.lastTrackUrl===e.url){u("Track hasn't changed");return}const a={name:l.appName||n.DEFAULT_APP_NAME,flags:0,type:l.listeningTo?2:0,details:e.name,state:`by ${e.artist}`,application_id:n.APPLICATION_ID,assets:{},buttons:[]};if(a.name.includes("{{"))for(const s in e)a.name=a.name.replace(`{{${s}}}`,e[s]||"");if(l.showTimestamp&&typeof e.from=="number"&&(a.timestamps={start:e.from*1e3,...typeof e.to=="number"&&{end:e.to*1e3}}),e.album){const s=await S([e.albumArt]);s[0]&&(a.assets={large_image:s[0],large_text:`on ${e.album}${l.showTimestamp&&e.to?` \u2022 ${j((e.to-e.from)/1e3)}`:""}`})}u("Setting activity:",a),b("lastActivity",a),await D(a),p.lastTrackUrl=e.url,p.lastActivity=a,this.consecutiveFailures=0,u("Activity set successfully!")}catch(e){console.error("[Last.fm] Update error:",e),this.handleError(e)}}},{key:"handleError",value:function(e){this.consecutiveFailures++,this.consecutiveFailures>=n.MAX_RETRY_ATTEMPTS&&(u(`Failed ${this.consecutiveFailures} times, initiating reconnection...`),this.startReconnection())}},{key:"startReconnection",value:function(){var e=this;this.isReconnecting||(this.isReconnecting=!0,this.stopUpdates(),u("Starting reconnection process"),this.reconnectTimer=setInterval(function(){u("Attempting to reconnect..."),e.initialize().then(function(){u("Reconnection successful"),e.stopReconnection()}).catch(function(a){u("Reconnection failed:",a)})},n.RETRY_DELAY))}},{key:"stopReconnection",value:function(){this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=void 0),this.isReconnecting=!1,this.consecutiveFailures=0}},{key:"stopUpdates",value:function(){this.updateTimer&&(clearInterval(this.updateTimer),this.updateTimer=void 0)}},{key:"initialize",value:async function(){var e=this;if(p.pluginStopped)throw new Error("Plugin is stopped");this.stopUpdates(),await this.updateActivity();const a=Math.max((Number(l.timeInterval)||n.DEFAULT_SETTINGS.timeInterval)*1e3,n.MIN_UPDATE_INTERVAL*1e3);this.updateTimer=setInterval(function(){return e.updateActivity()},a),u(`Update timer started with interval: ${a}ms`)}},{key:"stop",value:function(){p.pluginStopped=!0,this.stopUpdates(),this.stopReconnection(),N()}}],[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}]),t}().getInstance(),x=function(){return V.initialize()},B=function(){return V.stop()},q=[{version:"2.3.0",date:"2025-09-19",changes:["1. I TRIED SO HARD 2. remove backend error 3. factor settings tab 4. factor V2 5. factor V3 6. factor V4 7. factor V5 8. factor V6 9. Full settings refactor :3"]},{version:"2.2.0",date:"2025-09-13",changes:["Remember kids! Do not sniff crack!"]},{version:"2.0.0",date:"2025-09-13",changes:["Fix settings scrolling"]},{version:"1.3.0",date:"2025-09-13",changes:["fix reanimated"]},{version:"1.2.0",date:"2025-09-13",changes:["test"]},{version:"1.1.0",date:"2025-09-12",changes:["fixed reanimated issue??"]}],X="2.3.0",{ScrollView:J}=h.findByProps("ScrollView"),{TableRowGroup:A,TableSwitchRow:R,Stack:k,TableRow:f}=h.findByProps("TableSwitchRow","TableRowGroup","Stack","TableRow"),{TextInput:P}=h.findByProps("TextInput");h.findByProps("FormText");const g=function(t,e=""){return I.plugin.storage[t]??e},m=function(t,e){return I.plugin.storage[t]=e};function Q(){const[t,e]=r.React.useReducer(function(i){return~i},0),a=function(){return e()},[s,c]=r.React.useState(!1),o=async function(){const i=g("username"),y=g("apiKey");if(!i||!y){T.showToast("Please enter both username and API key",d.getAssetIDByName("Small"));return}c(!0);try{await v.fetchLatestScrobble(),T.showToast("Connection successful!",d.getAssetIDByName("Check")),await x()}catch(L){T.showToast(`Connection failed: ${L.message}`,d.getAssetIDByName("Small"))}finally{c(!1)}};return r.React.createElement(J,{style:{flex:1},contentContainerStyle:{padding:10}},r.React.createElement(k,{spacing:8},r.React.createElement(A,{title:"Account Settings"},r.React.createElement(k,{spacing:4},r.React.createElement(P,{placeholder:"Last.fm Username",value:g("username"),onChange:function(i){m("username",i),a()},isClearable:!0}),r.React.createElement(P,{placeholder:"API Key",value:g("apiKey"),onChange:function(i){m("apiKey",i),a()},secureTextEntry:!0,isClearable:!0}),r.React.createElement(f,{label:"Get API Key",subLabel:"https://www.last.fm/api/",onPress:function(){return C.Linking.openURL("https://www.last.fm/api/")}})),r.React.createElement(f,{label:"Test Connection",trailing:s?r.React.createElement(f.Arrow,{loading:!0}):r.React.createElement(f.Arrow,null),onPress:o,disabled:s})),r.React.createElement(A,{title:"Display Settings"},r.React.createElement(k,{spacing:4},r.React.createElement(P,{placeholder:`App Name (Default: ${n.DEFAULT_SETTINGS.appName})`,value:g("appName",n.DEFAULT_SETTINGS.appName),onChange:function(i){m("appName",i),a()},isClearable:!0}),r.React.createElement(P,{placeholder:`Update Interval (Default: ${n.DEFAULT_SETTINGS.timeInterval}s)`,value:String(g("timeInterval",n.DEFAULT_SETTINGS.timeInterval)),onChange:function(i){const y=Number(i);y>=n.MIN_UPDATE_INTERVAL?(m("timeInterval",y),a()):T.showToast(`Minimum interval is ${n.MIN_UPDATE_INTERVAL} seconds`,d.getAssetIDByName("Small"))},keyboardType:"numeric",isClearable:!0}))),r.React.createElement(A,{title:"Options"},r.React.createElement(R,{label:"Show 'Listening to' instead of 'Playing'",value:g("listeningTo",n.DEFAULT_SETTINGS.listeningTo),onValueChange:function(i){m("listeningTo",i),a()}}),r.React.createElement(R,{label:"Show Timestamp",value:g("showTimestamp",n.DEFAULT_SETTINGS.showTimestamp),onValueChange:function(i){m("showTimestamp",i),a()}}),r.React.createElement(R,{label:"Ignore when Spotify is playing",value:g("ignoreSpotify",n.DEFAULT_SETTINGS.ignoreSpotify),onValueChange:function(i){m("ignoreSpotify",i),a()}}),r.React.createElement(R,{label:"Verbose Logging",value:g("verboseLogging",n.DEFAULT_SETTINGS.verboseLogging),onValueChange:function(i){m("verboseLogging",i),a()}}),r.React.createElement(f,{label:"Idle Display Mode",subLabel:n.IDLE_DISPLAY_OPTIONS.find(function(i){return i.value===g("idleDisplayMode",n.DEFAULT_SETTINGS.idleDisplayMode)})?.label||"Last Played Song",trailing:r.React.createElement(f.Arrow,null),onPress:function(){const i=n.IDLE_DISPLAY_OPTIONS.map(function(M){return M.label}).join(`
`),y=prompt(`Select idle display mode:
${i}`,String(n.IDLE_DISPLAY_OPTIONS.findIndex(function(M){return M.value===g("idleDisplayMode",n.DEFAULT_SETTINGS.idleDisplayMode)})+1)),L=Number(y)-1;!isNaN(L)&&n.IDLE_DISPLAY_OPTIONS[L]&&(m("idleDisplayMode",n.IDLE_DISPLAY_OPTIONS[L].value),a())}})),r.React.createElement(A,{title:"Plugin Status"},r.React.createElement(f,{label:"Status",subLabel:p.pluginStopped?"Stopped":"Running"}),r.React.createElement(f,{label:"Last Update",subLabel:p.lastTrackUrl?"Success":"No track data"})),r.React.createElement(A,{title:"About"},r.React.createElement(f,{label:"Version",subLabel:X}),r.React.createElement(f,{label:"View Changelog",trailing:r.React.createElement(f.Arrow,null),onPress:function(){C.Linking.openURL(n.GITHUB_COMMITS_URL)}})),r.React.createElement(A,{title:"Changelog"},q.map(function(i,y){return r.React.createElement(f,{key:y,label:`v${i.version} (${i.date})`,subLabel:i.changes.join(", ")})}))))}const p={pluginStopped:!1,lastActivity:void 0,updateInterval:void 0,lastTrackUrl:void 0},Y=n.DEFAULT_SETTINGS;for(const t in Y)I.plugin.storage[t]=I.plugin.storage[t]??Y[t];const l=new Proxy(I.plugin.storage,{get(t,e){return t[e]},set(t,e,a){return t[e]=a,!0}});let U=0;const W=3,Z=5e3;async function _(){try{await x(),U=0}catch(t){console.error("[Last.fm] Initialization error:",t),U++,U<W?(T.showToast("Retrying connection...",d.getAssetIDByName("ic_clock")),setTimeout(_,Z)):T.showToast("Failed to connect to Last.fm",d.getAssetIDByName("Small"))}}var ee={onLoad(){if(p.pluginStopped=!1,!l.username||!l.apiKey){T.showToast("Please configure Last.fm username and API key in settings",d.getAssetIDByName("ic_warning"));return}if(G.getCurrentUser())_();else{const t=function(){G.getCurrentUser()&&(_(),r.FluxDispatcher.unsubscribe("CONNECTION_OPEN",t))};r.FluxDispatcher.subscribe("CONNECTION_OPEN",t)}},onUnload(){p.pluginStopped=!0,B()},onSettingsUpdate(t){Object.assign(l,t),_()},onDiscordReconnect(){p.pluginStopped||_()},settings:Q};return E.currentSettings=l,E.default=ee,E.pluginState=p,Object.defineProperty(E,"__esModule",{value:!0}),E})({},vendetta,vendetta.metro.common,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.components,vendetta.metro,vendetta.metro.common.ReactNative);
